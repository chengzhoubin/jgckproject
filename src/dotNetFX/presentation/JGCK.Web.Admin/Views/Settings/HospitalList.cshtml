@using JGCK.Util
@using Webdiyer.WebControls.Mvc
@model JGCK.Web.Admin.Models.VmHospitalIndex
<div class="page-bar">
    <ul class="page-breadcrumb">
        <li>
            <a href="index.html">基础管理</a>
            <i class="fa fa-circle"></i>
        </li>
        <li>
            <span>医院管理</span>
        </li>
    </ul>
    <div class="page-toolbar">
        <div class="btn-group pull-right">
            <button type="button" class="btn green btn-sm btn-outline" @@click="click_showPop()"> 新增 </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">

        <div class="portlet light">
            <div class="portlet-body">
                <div class="table-toolbar">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="input-group input-group-sm">
                                    @Html.TextBoxFor(m => m.Filter, new { @class = "form-control", placeholder = "医院编号、医院名称" })
                                    <span class="input-group-btn">
                                        <button id="btnSearch" class="btn green" type="button">搜索</button>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <table class="table table-striped table-bordered table-hover dataTable" id="sample_1">
                        <thead>
                            <tr>
                                <th class="sorting_asc"> 序号 </th>
                                <th class="sorting"> 医院编号 </th>
                                <th @@click="click_setsort('Name')" :class="get_sortCLass('Name')"> 医院名称 </th>
                                <th @@click="click_setsort('HospitalType')" :class="get_sortCLass('HospitalType')"> 医院属性 </th>
                                <th @@click="click_setsort('PaymentType')" :class="get_sortCLass('PaymentType')"> 付款方式 </th>
                                <th @@click="click_setsort('PaymentPeriod')" :class="get_sortCLass('PaymentPeriod')"> 付款周期 </th>
                                <th @@click="click_setsort('SaleRate')" :class="get_sortCLass('SaleRate')"> 折扣系数 </th>
                                <th> 收件联系人 </th>
                                <th> 联系电话 </th>
                                <th> 操作 </th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model?.ViewObjects != null)
                            {
                                var itemIndex = 1;
                                foreach (var item in Model.ViewObjects)
                                {
                                    <tr>
                                        <td> @((Model.CurrentIndex - 1) * Model.PageSize + itemIndex) </td>
                                        <td> @item.NagigatedDomainObject.HCode </td>
                                        <td> @item.NagigatedDomainObject.Name </td>
                                        <td> @item.NagigatedDomainObject.HospitalType.GetEnumDescription() </td>
                                        <td> @item.NagigatedDomainObject.PaymentType.GetEnumDescription() </td>
                                        <td> @item.NagigatedDomainObject.PaymentPeriod.GetEnumDescription() </td>
                                        <td> @($"{item.NagigatedDomainObject.SaleRate:0.00}") </td>
                                        <td> @(item.NagigatedDomainObject.HospitalReferences?.FirstOrDefault()?.Receipter) </td>
                                        <td> @(item.NagigatedDomainObject.HospitalReferences?.FirstOrDefault()?.ReceipterPhone) </td>
                                        <td> <button type="button" class="btn green btn-sm" @@click="click_showPop(@(item.HiddenJsonString))"> 操作 </button> </td>
                                    </tr>
                                    itemIndex++;
                                }
                            }
                        </tbody>
                    </table>
                    <div>
                        @Html.Pager(Model.TotalRecordCount, Model.PageSize, Model.CurrentIndex, new PagerOptions
                        {
                            PageIndexParameterName = "p",
                            ContainerTagName = "ul",
                            CssClass = "pagination pagination-sm",
                            CurrentPagerItemTemplate = "<li class=\"active\"><a href=\"javascript:; \"> {0} </a></li>",
                            DisabledPagerItemTemplate = "<li><a href=\"javascript:; \"> {0} </a></li>",
                            PagerItemTemplate = "<li>{0}</li>"
                        })
                    </div>
                </div>
            </div>
            <!-- END SAMPLE TABLE PORTLET-->
        </div>
    </div>
</div>




<div class="modal fade" id="modelfull" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-full">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">医院信息</h4>
            </div>
            <div class="modal-body">

                <div class="tabbable-line">
                    <ul class="nav nav-tabs ">
                        <li class="active">
                            <a href="#tab_15_1" data-toggle="tab"> 基本信息 </a>
                        </li>
                        <li>
                            <a href="#tab_15_2" data-toggle="tab"> 资质文件 </a>
                        </li>
                        <li>
                            <a href="#tab_15_3" data-toggle="tab"> 备注 </a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="tab_15_1">
                            <form action="#" class="horizontal-form">
                                <div class="form-body">
                                    <h3 class="form-section">基本信息</h3>
                                    <div class="row">
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label class="control-label">医院编号&nbsp;<span style="color:red">*</span></label>
                                                <input type="text" id="hospitalNo" class="form-control" placeholder="医院编号" v-model="model.HCode">
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label class="control-label">医院名称&nbsp;<span style="color:red">*</span></label>
                                                <input type="text" id="hospitalName" class="form-control" placeholder="医院名称" v-model="model.Name">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="control-label">医院地址&nbsp;<span style="color:red">*</span></label>
                                                <input type="text" id="hospitalAddress" class="form-control" placeholder="医院地址" v-model="model.Address">

                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label class="control-label">医院属性&nbsp;<span style="color:red">*</span></label>
                                                <select class="form-control" id="hospitalSuxing" v-model="model.HospitalType">
                                                    <option value="1">公立</option>
                                                    <option value="2">私立</option>
                                                    <option value="3">集团</option>
                                                    <option value="4">其他</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="control-label">折扣系数&nbsp;<span style="color:red">*</span></label>
                                                <input type="text" class="form-control" placeholder="" id="zk" v-model="model.SaleRate">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label class="control-label">付款方式&nbsp;<span style="color:red">*</span></label>
                                                <select class="form-control" id="paymethod" v-model="model.PaymentType">
                                                    <option value="1">基本账号</option>
                                                    <option value="2">Alipay</option>
                                                    <option value="4">其他</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3" v-if="model.PaymentType==4">
                                            <div class="form-group">
                                                <label class="control-label" v-if="model.PaymentType==4">付款方式备注</label>
                                                <input type="text" v-if="model.PaymentType==4" id="paymethodMark" class="form-control" placeholder="付款方式备注" v-model="model.PaymentNote">
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label class="control-label">付款周期&nbsp;<span style="color:red">*</span></label>
                                                <select class="form-control" id="paymethodTime" v-model="model.PaymentPeriod">
                                                    <option value="1">一个月</option>
                                                    <option value="2">预付</option>
                                                    <option value="4">其他</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3" v-if="model.PaymentPeriod==4">
                                            <div class="form-group">
                                                <label class="control-label" v-if="model.PaymentPeriod==4">付款方式备注</label>
                                                <input type="text" v-if="model.PaymentPeriod==4" id="paymethodTimemark" class="form-control" placeholder="付款周期" v-model="model.PaymentPeriodNote">
                                            </div>
                                        </div>
                                    </div>

                                    <section v-for="item in model.HospitalInvoices">
                                        <h3 class="form-section">开票信息</h3>

                                        <div class="row">
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>开票抬头</label>
                                                    <input type="text" class="form-control" v-model="item.Title">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>纳税人识别号</label>
                                                    <input type="text" class="form-control" v-model="item.TaxerNumber">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>开票地址</label>
                                                    <input type="text" class="form-control" v-model="item.InvoiceAddress">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>开票电话</label>
                                                    <input type="text" class="form-control" v-model="item.InvoicePhone">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>开户银行</label>
                                                    <input type="text" class="form-control" v-model="item.Bank">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>开户行账号</label>
                                                    <input type="text" class="form-control" v-model="item.BankAccountNumber">
                                                </div>
                                            </div>
                                        </div>

                                        <h3 class="form-section">发票联系人</h3>
                                        <div class="row">
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>姓名</label>
                                                    <input type="text" class="form-control" v-model="item.ContractPerson">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>职务</label>
                                                    <input type="text" class="form-control" v-model="item.CpJobTitle">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>电话</label>
                                                    <input type="text" class="form-control" v-model="item.CpPhone">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>地址</label>
                                                    <input type="text" class="form-control" v-model="item.CpAddress">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>财务科电话</label>
                                                    <input type="text" class="form-control" v-model="item.FinanceDepPhone">
                                                </div>
                                            </div>
                                        </div>
                                    </section>

                                    <section v-for="item in model.HospitalReferences">
                                        <h3 class="form-section">收件人</h3>
                                        <div class="row">
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>姓名</label>
                                                    <input type="text" class="form-control" v-model="item.Receipter">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>职务</label>
                                                    <input type="text" class="form-control" v-model="item.ReceipterJobTitle">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>电话</label>
                                                    <input type="text" class="form-control" v-model="item.ReceipterPhone">
                                                </div>
                                            </div>
                                        </div>
                                        <h3 class="form-section">账单联系人</h3>
                                        <div class="row">
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>姓名</label>
                                                    <input type="text" class="form-control" v-model="item.BillContactPerson">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>职务</label>
                                                    <input type="text" class="form-control" v-model="item.BcpJobTitle">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>电话</label>
                                                    <input type="text" class="form-control" v-model="item.BcpPhone">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>邮箱</label>
                                                    <input type="text" class="form-control" v-model="item.BcpEmail">
                                                </div>
                                            </div>
                                        </div>


                                    </section>
                                </div>

                            </form>
                        </div>
                        <div class="tab-pane" id="tab_15_2">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="control-label">营业执照<b>(5M以内)</b></label>
                                        <div>
                                            <img v-if="model.BusinessLicensePic&&!imgTempUpLoad1" :src="model.BusinessLicensePic" style="max-width:100px;max-height:100%;" id="img1" />
                                            <span class="btn btn-success fileinput-button">
                                                <i class="glyphicon glyphicon-plus"></i>
                                                <span>上传文件</span>
                                                <input id="fileupload1" type="file" name="files[]">
                                            </span>
                                            <br />
                                            <span id="files_preview1" class="files"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">

                                    <div class="form-group">
                                        <label class="control-label">医疗机构执业许可证<b>(5M以内)</b></label>
                                        <div>
                                            <img v-if="model.MedicalInstitutionLicensePic&&!imgTempUpLoad2" :src="model.MedicalInstitutionLicensePic" style="max-width:100px;max-height:100%;" id="img2" />

                                            <span class="btn btn-success fileinput-button">
                                                <i class="glyphicon glyphicon-plus"></i>
                                                <span>上传文件</span>
                                                <input id="fileupload2" type="file" name="files[]">
                                            </span>
                                            <br />
                                            <span id="files_preview2" class="files"></span>
                                        </div>
                                    </div>

                                </div>

                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="control-label">其他证明文件<b>(5M以内)</b></label>
                                        <div>
                                            <img v-if="model.CertificationPic&&!imgTempUpLoad3" :src="model.CertificationPic" style="max-width:100px;max-height:100%;" id="img3" />

                                            <span class="btn btn-success fileinput-button">
                                                <i class="glyphicon glyphicon-plus"></i>
                                                <span>上传文件</span>
                                                <input id="fileupload3" type="file" name="files[]">
                                            </span>
                                            <br />
                                            <span id="files_preview3" class="files"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab_15_3">
                            <div class="row">
                                <div class="col-md-12">
                                    <script id="myEditor" name="content" type="text/plain">
                                    </script>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                @*has-error*@

                <div class="modal-footer">
                    @*<button type="button" v-if="model.ID" class="btn green pull-left" @@click="click_delete()">删除</button>*@
                    <span style="color:red;font-size:15px;font-weight:bold;">{{errMsg}}</span>
                    <button type="button" class="btn green" @@click="click_save()">保存</button>
                    <button type="button" class="btn dark btn-outline" data-dismiss="modal">关闭</button>
                </div>
            </div>

        </div>
    </div>
</div>
@Html.Partial("_ParitalNoticeForm")


@section referenceHeader{
    <link href="~/assets/global/plugins/umeditor/themes/default/css/umeditor.css" type="text/css" rel="stylesheet">
    <link href="~/assets/global/plugins/jquery-file-upload/css/jquery.fileupload.css" rel="stylesheet" type="text/css" />
    <script>
        var pageUrl = "/Settings/HospitalList"
    </script>
}


@section scripts{
    <script src="~/assets/global/plugins/bootbox/bootbox.min.js"></script>
    <script src="~/assets/global/plugins/jquery-file-upload/js/vendor/jquery.ui.widget.js" type="text/javascript"></script>
    <script src="~/assets/global/plugins/jquery-file-upload/js/vendor/load-image.min.js" type="text/javascript"></script>
    <script src="~/assets/global/plugins/jquery-file-upload/js/vendor/canvas-to-blob.min.js" type="text/javascript"></script>
    <script src="~/assets/global/plugins/jquery-file-upload/js/jquery.iframe-transport.js" type="text/javascript"></script>
    <script src="~/assets/global/plugins/jquery-file-upload/js/jquery.fileupload.js" type="text/javascript"></script>
    <script src="~/assets/global/plugins/jquery-file-upload/js/jquery.fileupload-process.js" type="text/javascript"></script>
    <script src="~/assets/global/plugins/jquery-file-upload/js/jquery.fileupload-image.js" type="text/javascript"></script>
    <script src="~/assets/global/plugins/jquery-file-upload/js/jquery.fileupload-audio.js" type="text/javascript"></script>
    <script src="~/assets/global/plugins/jquery-file-upload/js/jquery.fileupload-video.js" type="text/javascript"></script>
    <script src="~/assets/global/plugins/jquery-file-upload/js/jquery.fileupload-validate.js" type="text/javascript"></script>
    <script src="~/assets/global/scripts/fileupload.js" type="text/javascript"></script>
    <script type="text/javascript" charset="utf-8" src="~/assets/global/plugins/umeditor/umeditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="~/assets/global/plugins/umeditor/umeditor.min.js"></script>
    <script type="text/javascript" src="~/assets/global/plugins/umeditor/lang/zh-cn/zh-cn.js"></script>



    <!-- 实例化编辑器 -->
    <script type="text/javascript">
        var um;
        $(function () {     
                um = UM.getEditor('myEditor');
                $("#btnSearch").click(function () {
                    if ($("#Filter").val() == "") {
                        location.href = '@Url.Action("HospitalList")';
                        return;
                    }
                    var reloadUrlWithFilter = '@Url.Action("HospitalList")?filter=' + encodeURI($("#Filter").val());
                    location.href = reloadUrlWithFilter;
                });

                fileuploadModule('#fileupload1', '#files_preview1', false, function (data) {                    
                    app.imgTempUpLoad1 = data.result.Value
                }, 'business:license', 100, 100);
                fileuploadModule('#fileupload2', '#files_preview2', false, function (data) {
                    app.imgTempUpLoad2 = data.result.Value
                    }, 'medicalinstitution:license',100, 100);
                fileuploadModule('#fileupload3', '#files_preview3', false, function (data) {
                    app.imgTempUpLoad3 = data.result.Value           
                }, 'certification:license', 100, 100);
            });

            var app = new Vue({
                el: '#app',
                data: {
                    model: {},
                    errMsg: "",
                    imgTempUpLoad1: "",
                    imgTempUpLoad2: "",
                    imgTempUpLoad3: "",

                },
                methods: {
                    get_sortCLass: function (sortName) {
                        var _tmp = _.where(this.sort_keys, { SortProperty: sortName });
                        if (_tmp.length === 0) return 'sorting';
                        return (_tmp && _tmp.length > 0 && _tmp[0].SortDirect === 1 ? "sorting_desc" : "sorting_asc");
                    },
                    click_showPop: function (Obj) {
                        this.imgTempUpLoad1 = "";
                        this.imgTempUpLoad2 = "";
                        this.imgTempUpLoad3 = "";
                        if (Obj) {
                            if (!Obj.NagigatedDomainObject.HospitalInvoices || Obj.NagigatedDomainObject.HospitalInvoices.length==0) Obj.NagigatedDomainObject.HospitalInvoices = [{}];
                            if (!Obj.NagigatedDomainObject.HospitalReferences || Obj.NagigatedDomainObject.HospitalReferences.length == 0) Obj.NagigatedDomainObject.HospitalReferences = [{}];
                            this.model = Obj.NagigatedDomainObject
                        } else {
                            this.model = {
                                HospitalComments:'',
                                HospitalInvoices: [{}],
                                HospitalReferences: [{}]
                            };
                        }
                        console.log(Obj)
                        if (this.model.HospitalComments) {
                            UM.getEditor('myEditor').setContent(Obj.NagigatedDomainObject.HospitalComments);
                        } else {
                            UM.getEditor('myEditor').setContent("");
                        }
                        $('#modelfull').modal('show');
                    },
                    click_setsort: function (Name) {
                        var _tmp = _.where(this.sort_keys, { SortProperty: Name });
                        var SortDirect = (_tmp && _tmp.length > 0 && _tmp[0].SortDirect === 1 ? "Desc" : "Asc");
                        Cookies.remove('sf_hospitalData_sort_keys');
                        $.post("/ajaxcommon/setsort/", {
                            "module": "sf_hospitalData_sort_keys",
                            "sortby": Name,
                            "directby": SortDirect
                        }).then(item => {
                            window.location.reload();
                        });
                    },
                    click_delete: function () {
                        var that = this
                        bootbox.confirm({
                            message: "确定要删除吗?",
                            size: "small",
                            buttons: {
                                confirm: {
                                    label: '删除',
                                    className: 'btn-success'
                                },
                                cancel: {
                                    label: '关闭',
                                    className: 'btn-danger'
                                }
                            },
                            callback: function (result) {
                                if (result) {
                                    console.log(that.model);
                                    $.post("/Settings/DeleteHospital", {
                                        hId: that.model.ID
                                    }).then(item => {
                                        if (item.Result) {
                                           window.location.reload();
                                           that.errMsg = "删除成功"
                                        } else {
                                            that.errMsg = item.Err
                                        }
                                    });
                                }
                            }
                        });
                    },
                    click_save: function () {
                        console.log(this.model)
                        var that = this;
                        var apiUrl = "/Settings/UpdateHospital"
                        if (!this.model.ID) {
                            apiUrl = "/Settings/AddHospital"
                        } 
                        if (this.imgTempUpLoad1) app.model.BusinessLicensePic = this.imgTempUpLoad1;
                        if (this.imgTempUpLoad2) app.model.MedicalInstitutionLicensePic = this.imgTempUpLoad2;
                        if (this.imgTempUpLoad3) app.model.CertificationPic = this.imgTempUpLoad3;
                        app.model.HospitalComments = UM.getEditor('myEditor').getContent();
                        if (this.isRuning) return;
                        this.isRuning = true;
                        $.post(apiUrl, {
                            NagigatedDomainObject: this.model
                        }).then(item => {
                            that.isRuning = false;
                            console.log(item);
                            if (item.Result) {
                                //that.errMsg = "操作成功"
                                $("#successModal").modal('show');
                                //window.location.reload();
                            } else {
                                that.errMsg = item.Err
                            }
                            });

                    }
                }
            })




    </script>
}
