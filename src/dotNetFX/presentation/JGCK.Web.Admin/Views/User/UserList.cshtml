@using Webdiyer.WebControls.Mvc
@using JGCK.Util
@model JGCK.Web.Admin.Models.VmUserStaffIndex
<div class="page-bar">
    <ul class="page-breadcrumb">
        <li>
            <a href="#">基础管理</a>
            <i class="fa fa-circle"></i>
        </li>
        <li>
            <span>员工管理</span>
        </li>
    </ul>
    <div class="page-toolbar">
        <div class="btn-group pull-right">
            <button type="button" class="btn green btn-sm btn-outline" @@click="click_showDoctorPop()"> 新增 </button>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <!-- BEGIN SAMPLE TABLE PORTLET-->
        <div class="portlet light">
            <div class="portlet-body">
                <div class="table-toolbar">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <!--<label>Small Input Default Group</label>-->
                                <div class="input-group input-group-sm">
                                    @Html.TextBoxFor(m => m.Filter, new { @class = "form-control", placeholder = "姓名、电话" })
                                    <span class="input-group-btn">
                                        <button id="btnSearch" class="btn green" type="button">搜索</button>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <style>
                        .ul-person li {
                            list-style: none;
                            float: left;
                            margin: 10px;
                        }

                            .ul-person li .item {
                                display: inline-block;
                                height: 50px;
                                color: #fff;
                                background-color: #ff8666;
                                padding: 15px;
                                border-radius: 5px !important;
                                overflow: hidden;
                            }
                    </style>
                    <table class="table table-striped table-bordered table-hover dataTable" id="sample_1">
                        <thead>
                            <tr>
                                <th> 序号 </th>
                                <th @@click="click_setsort('Role.Name')" :class="get_sortCLass('Role.Name')"> 角色 </th>
                                <th @@click="click_setsort('DepartmentName')" :class="get_sortCLass('DepartmentName')"> 所属部门 </th>
                                <th @@click="click_setsort('PersonType')" :class="get_sortCLass('PersonType')"> 员工类型	 </th>
                                <th @@click="click_setsort('Name')" :class="get_sortCLass('Name')"> 用户名 </th>
                                <th @@click="click_setsort('RealName')" :class="get_sortCLass('RealName')"> 姓名 </th>
                                <th> 性别 </th>
                                <th> 学历 </th>
                                <th> 毕业学校 </th>
                                <th> 专业 </th>
                                <th> 联系电话 </th>
                                <th> 操作 </th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                if (Model != null && Model.ViewObjects != null)
                                {
                                    var itemIndex = 1;
                                    foreach (var item in Model.ViewObjects)
                                    {
                                        <tr>
                                            <td> @((Model.CurrentIndex - 1) * Model.PageSize + itemIndex) </td>
                                            <td> @(item.NagigatedDomainObject.Role?.Name) </td>
                                            <td> @item.NagigatedDomainObject.DepartmentName </td>
                                            <td> @item.NagigatedDomainObject.PersonType.ToDescription() </td>
                                            <td> @item.NagigatedDomainObject.Name </td>
                                            <td> @item.NagigatedDomainObject.RealName </td>
                                            <td> @item.NagigatedDomainObject.Sex.ToDescription() </td>
                                            <td> @item.NagigatedDomainObject.Education.ToDescription() </td>
                                            <td> @item.NagigatedDomainObject.GraduateInstitution </td>
                                            <td> @item.NagigatedDomainObject.Major </td>
                                            <td> @item.NagigatedDomainObject.Phone </td>
                                            <td> <button type="button" class="btn green btn-sm" @@click="click_showDoctorPop(@(item.HiddenJsonString))"> 编辑 </button> </td>
                                        </tr>
                                        itemIndex++;
                                    }
                                }
                            }
                        </tbody>
                    </table>
                    <div>
                        @Html.Pager(Model.TotalRecordCount, Model.PageSize, Model.CurrentIndex, new PagerOptions
                   {
                       PageIndexParameterName = "p",
                       ContainerTagName = "ul",
                       CssClass = "pagination pagination-sm",
                       CurrentPagerItemTemplate = "<li class=\"active\"><a href=\"javascript:; \"> {0} </a></li>",
                       DisabledPagerItemTemplate = "<li><a href=\"javascript:; \"> {0} </a></li>",
                       PagerItemTemplate = "<li>{0}</li>"
                   })
                    </div>
                </div>
            </div>
            <!-- END SAMPLE TABLE PORTLET-->
        </div>
    </div>
</div>

<div class="modal fade" id="modelfull" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-full">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">员工信息</h4>
            </div>
            <div class="modal-body">
                <div class="FormBody">
                    <div class="row">
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li> <strong>角色:</strong> <input type="text" v-model="doctor.Role.Name" /></li>
                            </ul>
                        </div>
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li> <strong>所属部门:</strong>  <input type="text" v-model="doctor.DepartmentName" /></li>
                            </ul>
                        </div>
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li>
                                    <strong>用户名:</strong><input type="text" v-model="doctor.Name" />
                                </li>
                            </ul>
                        </div>
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li>
                                    <strong>密码:</strong> <input type="password" v-model="doctor.Pwd" />
                                </li>
                            </ul>
                        </div>
                    </div>
                    <hr />
                    <div class="row">
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li>
                                    <strong>员工类型:</strong>
                                    <select v-model="doctor.PersonType">
                                        <option value="">请选择</option>
                                        <option :value="item.id" v-for="item in ListPersonType">{{item.name}}</option>
                                    </select>

                                </li>
                            </ul>
                        </div>
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li> <strong>姓名:</strong> <input type="text" v-model="doctor.RealName" /></li>
                            </ul>
                        </div>
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li>
                                    <strong>性别:</strong>
                                    <select v-model="doctor.Sex">
                                        <option value="">请选择</option>
                                        <option :value="item.id" v-for="item in ListSexList">{{item.name}}</option>
                                    </select>
                                </li>
                            </ul>
                        </div>
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li>
                                    <strong>身份证号:</strong> <input type="text" v-model="doctor.IdCard" />
                                </li>
                            </ul>
                        </div>
                    </div>
                    <hr />

                    <div class="row">
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li>
                                    <strong>学历:</strong>
                                    <select v-model="doctor.Education">
                                        <option value="">请选择</option>
                                        <option :value="item.id" v-for="item in ListEducationType">{{item.name}}</option>
                                    </select>
                                </li>
                            </ul>
                        </div>
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li> <strong>毕业学校:</strong> <input type="text" v-model="doctor.GraduateInstitution" /></li>
                            </ul>
                        </div>
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li>
                                    <strong>专业:</strong><input type="text" v-model="doctor.Major" />
                                </li>
                            </ul>
                        </div>
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li>
                                    <strong>Email:</strong><input type="text" v-model="doctor.Email" />
                                </li>
                            </ul>
                        </div>

                    </div>
                    <hr />
                    <div class="row">
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li> <strong>联系电话:</strong> <input type="text" v-model="doctor.Phone" /> </li>
                            </ul>
                        </div>
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li> <strong>紧急联系人:</strong> <input type="text" v-model="doctor.EmergencyContact" /></li>
                            </ul>
                        </div>
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li>
                                    <strong>紧急联系人电话:</strong><input type="text" v-model="doctor.EmergencyPhone" />
                                </li>
                            </ul>
                        </div>
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li>
                                    <strong>地址:</strong><input type="text" v-model="doctor.FamliyAddress" />
                                </li>
                            </ul>
                        </div>
                    </div>
                    <hr />
                    <div class="row">
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li class="form-inline">
                                    <strong>入职时间:</strong>
                                    @*<input type="text" v-model="doctor.HireDate" />*@
                                    <div class="form-group">
                                        <div class="input-group date form_datetime">
                                            <input class="form-control" readonly="readonly" id="HireDate" size="16" type="text" v-model="doctor.HireDate" />
                                            <span class="input-group-btn">
                                                <button class="btn default date-set" type="button">
                                                    <i class="fa fa-calendar"></i>
                                                </button>
                                            </span>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li class="form-inline">
                                    <strong>离职时间:</strong>
                                    @*<input type="text" v-model="doctor.LeaveDate" />*@
                                    <div class="form-group">
                                        <div class="input-group date form_datetime">
                                            <input class="form-control" readonly="readonly" id="LeaveDate" size="16" type="text" v-model="doctor.LeaveDate" />
                                            <span class="input-group-btn">
                                                <button class="btn default date-set" type="button">
                                                    <i class="fa fa-calendar"></i>
                                                </button>
                                            </span>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li class="form-inline">
                                    <strong>实习开始时间:</strong>
                                    @*<input type="text" v-model="doctor.PracticeBeginDate" />*@
                                    <div class="form-group">
                                        <div class="input-group date form_datetime">
                                            <input class="form-control" id="PracticeBeginDate" readonly="readonly" size="16" type="text" v-model="doctor.PracticeBeginDate" />
                                            <span class="input-group-btn">
                                                <button class="btn default date-set" type="button">
                                                    <i class="fa fa-calendar"></i>
                                                </button>
                                            </span>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="col-xs-3">
                            <ul class="list-unstyled">
                                <li class="form-inline">
                                    <strong>实习结束时间:</strong>
                                    @*<input type="text" v-model="doctor.PracticeEndDate" />*@
                                    <div class="form-group">
                                        <div class="input-group date form_datetime">
                                            <input class="form-control" readonly="readonly" id="PracticeEndDate" size="16" type="text" v-model="doctor.PracticeEndDate" />
                                            <span class="input-group-btn">
                                                <button class="btn default date-set" type="button">
                                                    <i class="fa fa-calendar"></i>
                                                </button>
                                            </span>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <hr />
                    <div class="row">
                        <div class="col-xs-12">
                            <strong style="float:left;">备注:</strong>
                            <script id="container" name="content" type="text/plain" style="height:250px">
                            </script>

                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                @*<button type="button" v-if="doctor.ID" class="btn green pull-left" @@click="click_delete()">删除</button>*@
                <span style="color:red;font-size:13px;">{{errMsg}}</span>
                <button type="button" class="btn green" @@click="click_save">保存</button>
                <button type="button" class="btn dark btn-outline" data-dismiss="modal">关闭</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>



@section referenceHeader{
    <script>
        var pageUrl = "/User/UserList"
    </script>
    <link href="~/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.css" rel="stylesheet" type="text/css" />
    <link href="~/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css" rel="stylesheet" type="text/css" />
    <link href="~/assets/global/plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css" rel="stylesheet" type="text/css" />
    <link href="~/assets/global/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="~/assets/global/plugins/umeditor/themes/default/css/umeditor.css">
    <style>
        .FormBody li strong {
            width: 140px;
            display: inline-block;
        }

        .edui-container {
            display: inline-block;
            border: 2px solid #d4d4d4;
            width: 100% !important;
        }
    </style>
}

@section scripts
{
    <script src="~/assets/global/plugins/bootbox/bootbox.min.js"></script>
    <script src="~/assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
    <script src="~/assets/global/plugins/bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>
    <script type="text/javascript" src="~/assets/global/plugins/umeditor/third-party/template.min.js"></script>
    <script type="text/javascript" src="~/assets/global/plugins/umeditor/umeditor.config.js"></script>
    <script type="text/javascript" src="~/assets/global/plugins/umeditor/umeditor.js"></script>
    <script>
        $(function() {
            $("#btnSearch").click(function () {
                if ($("#Filter").val() == "") {
                    location.href = '@Url.Action("UserList")';
                    return;
                }
                var reloadUrlWithFilter = '@Url.Action("UserList")?filter=' + encodeURI($("#Filter").val());
                location.href = reloadUrlWithFilter;
            });
            handleDatetimePicker();
            $(function () {
                var um = UM.getEditor('container', {});
            });

        })
        var handleDatetimePicker = function () {
            if (!jQuery().datetimepicker) {
                return;
            }
            var date = new Date();
            $(".form_datetime").datetimepicker({
                autoclose: true,
                isRTL: App.isRTL(),
                format: " yyyy-mm-dd hh:ii",
                startDate: '2018-1-1',
                todayHighlight: true,
                language: "zh-CN",
                pickerPosition: (App.isRTL() ? "bottom-right" : "bottom-left")
            });
            $('body').removeClass("modal-open");
        }
        var formatTime = function (value, needTime = true) {
            return value == "" || value == null || value == '1900-01-01T00:00:00' ? "" : moment(value).format(needTime ? "YYYY-MM-DD HH:mm" : "MM/DD/YYYY");
        }

        var app = new Vue({
            el: '#app',
            data: {
                doctor: {Role:""},
                errMsg:"",
                ListSexList: [

                                    @{
                                        string sexContent = "";
                                        foreach (var j in Model.SexList)
                                        {
                                            sexContent = sexContent + ",{id:" + j.Value + ", name:'" + j.Text + "'}";

                                        }
                                        if (sexContent.IndexOf(',') == 0)
                                        {
                                            sexContent = sexContent.Substring(1, sexContent.Length - 1);
                                        }

                                    }
                                   @Html.Raw(sexContent)

                                ],
                ListPersonType: [

                                        @{
                                            string personContent = "";
                                            foreach (var j in Model.PersonTypeList)
                                            {
                                                personContent = personContent + ",{id:" + j.Value + ", name:'" + j.Text + "'}";

                                            }
                                            if (personContent.IndexOf(',') == 0)
                                            {
                                                personContent = personContent.Substring(1, personContent.Length - 1);
                                            }

                                          }
                                        @Html.Raw(personContent)

                               ],
                ListEducationType: [

                                            @{
                                                string educationTypeContent = "";
                                                foreach (var e in Model.EducationTypeList)
                                                {
                                                    educationTypeContent = educationTypeContent + ",{id:" + e.Value + ", name:'" + e.Text + "'}"; ;

                                                }
                                                if (educationTypeContent.IndexOf(',') == 0)
                                                {
                                                    educationTypeContent = educationTypeContent.Substring(1, educationTypeContent.Length - 1);
                                                }

                                            }
                                             @Html.Raw(educationTypeContent)
                                   ]
            },
            created: function () {
                if (Cookies.get('sf_staffData_sort_keys')) this.sort_keys = JSON.parse(Cookies.get('sf_staffData_sort_keys'))
            },
            methods: {
                get_sortCLass: function (sortName) {
                    var _tmp = _.where(this.sort_keys, { SortProperty: sortName });
                    if (_tmp.length === 0) return 'sorting';
                    return (_tmp && _tmp.length > 0 && _tmp[0].SortDirect === 1 ? "sorting_desc" : "sorting_asc");
                },
                click_showDoctorPop: function (doctorObj) {
                    if (doctorObj) {
                        if (doctorObj.NagigatedDomainObject.HireDate) doctorObj.NagigatedDomainObject.HireDate = formatTime(doctorObj.NagigatedDomainObject.HireDate)
                        if (doctorObj.NagigatedDomainObject.LeaveDate) doctorObj.NagigatedDomainObject.LeaveDate = formatTime(doctorObj.NagigatedDomainObject.LeaveDate)
                        if (doctorObj.NagigatedDomainObject.PracticeBeginDate) doctorObj.NagigatedDomainObject.PracticeBeginDate = formatTime(doctorObj.NagigatedDomainObject.PracticeBeginDate)
                        if (doctorObj.NagigatedDomainObject.PracticeEndDate) doctorObj.NagigatedDomainObject.PracticeEndDate = formatTime(doctorObj.NagigatedDomainObject.PracticeEndDate)
                        if (!doctorObj.NagigatedDomainObject.Role) doctorObj.NagigatedDomainObject.Role = {}
                        this.doctor = doctorObj.NagigatedDomainObject
                    } else {
                        this.doctor = {
                            Role: {} }
                    }
                    $('#modelfull').modal('show')
                    console.log(this.doctor)
                },
                click_delete: function () {
                    var that = this

                    bootbox.confirm({
                        message: "确定要删除吗?",
                        size: "small",
                        buttons: {
                            confirm: {
                                label: '删除',
                                className: 'btn-success'
                            },
                            cancel: {
                                label: '关闭',
                                className: 'btn-danger'
                            }
                        },
                        callback: function (result) {
                            if (result) {
                                console.log(this.doctor);
                                $.post("/user/DeleteStaff", {
                                    staffId: that.doctor.ID
                                }).then(item => {
                                    if (item.Result) {
                                        window.location.reload();
                                        that.errMsg = "删除成功"
                                    } else {
                                        that.errMsg = item.Err
                                    }
                                });
                            }
                        }
                    });
                },
                click_setsort: function (Name) {
                    var _tmp = _.where(this.sort_keys, { SortProperty: Name });
                    var SortDirect = (_tmp && _tmp.length > 0 && _tmp[0].SortDirect === 1 ? "Desc" : "Asc");
                    Cookies.remove('sf_staffData_sort_keys');
                    $.post("/ajaxcommon/setsort/", {
                        "ModuleName": "sf_staffData_sort_keys",
                        "SortProperty": Name,
                        "SortDirect": SortDirect
                    }).then(item => {
                         window.location.reload();
                    });
                            },
                click_save: function () {
                    console.log(this.doctor)
                    var that = this;
                    var apiUrl = "/user/UpdateStaff"
                    if (!this.doctor.ID) {
                        this.doctor.Pwd = "123456";
                        apiUrl = "/user/AddStaff"
                    } else {

                    }

                    if ($("#HireDate").val()) this.doctor.HireDate = $("#HireDate").val()
                    if ($("#LeaveDate").val()) this.doctor.LeaveDate = $("#LeaveDate").val()
                    if ($("#PracticeBeginDate").val()) this.doctor.PracticeBeginDate = $("#PracticeBeginDate").val()
                    if ($("#PracticeEndDate").val()) this.doctor.PracticeEndDate = $("#PracticeEndDate").val()

                    if (this.isRuning) return;
                    this.isRuning = true;
                    $.post(apiUrl, {
                        NagigatedDomainObject: this.doctor
                    }).then(item => {
                        that.isRuning = false;
                        console.log(item);
                        if (item.Result) {
                            that.errMsg = "操作成功"
                            window.location.reload();
                        } else {
                            that.errMsg = item.Err
                        }
                    });

                 }

            }
        })
    </script>


}
